---
title: 'Spatial Analysis - Assignment #1'
output:
  html_document:
    df_print: paged
---

# Introduction
The impact of Airbnb on the urban economies around the world has been breakthrough. The Spanish city of Madrid is no exception (Gil and Sequera, 2019). Using a Madrid dataset from the Inside Airbnb project, the study aims to understand how the price of Airbnb changes geographically across the city. This might be crucial to understand potential policies and mitigations for the downside driven by Airbnb and similar house-sharing platforms (Barron et al., 2017; Wachsmuth et al., 2017; Horn et al., 2017). The research is divided into three parts. The first part has two steps. Firstly, using a KDE, the distribution of the listings is plotted. Secondly, using the Inverse Distance Weighted interpolation technique, a surface of the prices is shown.
In the second part, the modeling analysis starts. A baseline model is defined and subsequent edits are applied, including the log-transformation of the outcome (price). A first predictive check is conducted on both models.
In the third part, space is formally introduced in the modeling analyzing both the potential spatial heterogeneity and spatial dependence in the overall pricing process. A spatial fixed effect (model three) and spatial regimes (model four) technique are used to assess heterogeneity while the spatial lag is calculated to understand spatial dependence (model three). Predictive checks are extended two assess model three and model four predictability.

# Dependencies

```{r results = FALSE, message=FALSE, warning=FALSE}
# For pretty table
library(knitr)
# All things geodata
library(sf)
# Spatial objects conversion
library(sp)
# Pretty graphics
library(ggplot2)
library(gridExtra)
# Thematic maps
library(tmap)
# Pretty maps
library(ggmap)
# For all your interpolation needs
library(gstat)
# For data manipulation
library(plyr)
# Fitting multilevel models
library(lme4)
# Tools for extracting information generated by lme4
library(merTools)
# Exportable regression tables
library(jtools)
library(stargazer)
library(sjPlot)
# Various GIS utilities
library(GISTools)
# For all your interpolation needs
library(gstat)
# For data manipulation
library(dplyr)
# Spatial regression
library(spdep)

```

# Part I
**Methods**
A Kernel Density Estimation (KDE) is a surface that it is calculated to represent the continuous distribution of the listings across space. A color scheme is used to better visualize how the distribution changes.
Using a similar approach to KDE, a continuous surface of a phenomenon, spatial interpolation uses discrete points to create a surface interpolating them. In this case, the objective is to interpolate the prices of the Airbnb listings. The Inverse Distance Weight interpolation (IDW) technique is used to obtain the surface. To do so three steps are required. First, create a regular geometrical grid based on the existing house prices, secondly based on k nearest neighbors an estimate is calculated, thirdly plot the estimates to obtain the surface.

**Results and interpretation**
The KDE shows how the majority of the listings are centered around central Madrid (Figure 1). This shouldn't be surprising given the nature of Airbnb as service for travelers and tourists that usually prefer city-center locations.
The surface generated through the IDW shows how high prices should be distributed (Figure 2) in some areas in the center (eg. Chamberí), southern (eg. Villaverde) and central-eastern part of the city (eg. Retiro).

```{r results = FALSE, message=FALSE, warning=FALSE}
# Read DB
db <- st_read("data/madrid_abb.gpkg")
```
```{r results = FALSE, message=FALSE, warning=FALSE}
# Read column names
colnames(db)
```

```{r message=FALSE, warning=FALSE}
# Reproject coordinates
lon_lat <- st_transform(db, crs = 4326) %>%
  st_coordinates() %>%       # Retrieve coordinates in matrix form
  as.data.frame()            # Set them in a dataframe

# Basemap
qmplot(
  X, 
  Y,
  data = lon_lat,                         # Load previous calculated dataframe
  geom="blank",                           # Do not show current geometries (listings)
  zoom = 12,                              # Set zoom
  main ='Figure One - KDE Madrid map'     # Add title
) +
  stat_density2d_filled(                  # Add KDE on the map
    data = lon_lat,
    aes(x = X, y = Y, alpha = ..level..), # Set axis with the basemap and continuous transparency alpha level
    n = 16                                # Number of grid points
  ) +
  scale_fill_discrete()                   # Tweak the color gradient
```

```{r results = FALSE, message=FALSE, warning=FALSE}
# Calculate the grid for the IDW interpolation
sd.grid <- db %>%
  st_bbox() %>%                # Set a box            
  st_as_sfc() %>%              # Convert geometries to a sfc object
  st_make_grid(                # Set the grid with 100 cells
    n = 100,
    what = "centers"
  ) %>%
  st_as_sf() %>%               # Convert matrix into a sf object
  cbind(., st_coordinates(.))  # Combine by columns the coordinates
```

```{r results = FALSE, message=FALSE, warning=FALSE}
idw.hp <- idw(
  price_usd ~ 1,     # Formula for IDW
  locations = db,    # Initial locations with values from the existing db
  newdata=sd.grid    # Locations we want predictions for based on the existing cells
)
```

```{r results = FALSE, message=FALSE, warning=FALSE}
# Append coordinates to each grid cell
idw.hp = idw.hp %>%
  cbind(st_coordinates(.)) # Combine by columns the coordinates
```

```{r}
# Plot the surface of the prices
ggplot(idw.hp, aes(x = X, y = Y, fill = var1.pred)) +
  geom_raster() +
  scale_fill_distiller(palette = "YlOrBr") +             # Set color palette ('yellow to brown')
  labs(fill = "Price in USD") +                          # Rename legend
  ggtitle('Figure 2 - IDW interpolation of the price')   # Set title
```

# Part II
**Methods**  
Two models are designed. A baseline model (model one) with price as dependent value and the number of guests that the house might accommodate, the number of bathrooms, bedrooms and beds as independent variables.
Model two is identical to model one but the price is log-transformed since the distribution of the prices is very concentrated around lower values while having really high positive values (the blue line on Figure 3, top left). The log transformation shrinks the differences.
To assess the different scenarios for our models highlighting the uncertainty in the predictions, a predictive check for each of the model is run, obtaining a chart with the predictive value and the actual value of the predicted outcome (Figure 3). 
To both these charts it is added a third line. This line represents, through a custom built function, 300 random realizations of the predicted outcomes by a given model. These lines represent the model with its inferential component that includes the error and the inherent uncertainty in it. To measure the error of the models, the RMSE has been also calculated.

**Results and interpretation**  
As the predictive check and the Adjusted R-squared charts show, the predictive power of the first model is greatly lower than model two. Model two explains 24.38% of the variability of the log-price while model one only 2.25% of the price in US dollars.
The model two might also offer a better interpretation since an increase of one unit in the predictors might be approximated as a coefficient percentage change in the outcome variable given the log transformation. In this case, all else equal, an increase in 1 accommodation increase the price by 21.9%, an increase by 1 bedroom by 12.2%, while an increase in 1 extra bathroom or 1 extra bed should slightly decrease the price respectively by 4.4% and 6.0%.
The result contrasts with previous literature suggesting the positive role of the number of bathrooms in increasing the final price (Perez-Sanchez et al., 2018). Lastly, while in model two the predictors are all highly statistically significant, in model one, the ‘bathrooms’ predictor is not statistically significant.
The first two lines represent a state of reality that is completely deterministic. The chart suggested that for a certain X-axis value there is one and only one value predicted value while instead, the error term across multiple iterations may show how the predicted value changes based on the implicit uncertainty of the process. In some cases, like in the log-price model for values around 2, there are no predicted values at all. This result shows how there is no uncertainty in our models. However, every OLS model has a predictive (the deterministic part) and inferential (uncertain part) component and for an X-axis value, there might be multiple predicted outcomes based on the iteration of the random realization of the predictions from a specific model. This is built-in R through a function that does exactly that. The result is a range of lines that shows how the error of the model (the inferential part) randomly changes the predicted outcome (price or log-price).
The charts show how especially model one could lead to pretty misleading results when it comes to inferring the general process explaining the price of an Airbnb listing. This might be because the model is badly accurate and/or badly precise. The values are less concentrated (green line versus black line) and this might happen because the error is pretty large given the low explanatory power of the model like the adjusted R-squared suggests, and because the accuracy is low, in other words, it is not capable to infer the general process.
The log-price model seems more precise (higher adjusted R-squared) but it seems very concentrated in the distribution of the predictions potentially suggesting that the accuracy is low.
The Root Mean Squared Error (RMSE) is the average squared difference between the predicted values and the actual values. This difference is roughly 358 for model one and 0.77 for model two. The RMSE between the two models is radically different. It is worth noticing how the RMSE is an absolute measure of the error and the two values should not be directly compared. For model one, the high RMSE value could mean that the predicted house price might off by 358 dollars. This result might come without a surprise given the very low adjusted R-squared value and suggests disregarding this model.
For model two, the interpretation is slightly different given the fact that RMSE is of a log variable. The value is artificially low given that the price is log-transformed but it is substantially relevant given that the log-price is between 0 and 1.
```{r results = FALSE, message=FALSE, warning=FALSE}
# Create first OLS model - Baseline Model - Model One
m1 <- lm('price_usd ~ accommodates + bathrooms + bedrooms + beds', data=db)
# Show a summary of the results of the model (eg. coefficient, p-value)
summary(m1)
```
```{r}
# Create second OLS model
m2 <- lm('log1p_price_usd ~ accommodates + bathrooms + bedrooms + beds', data=db)
# Show a summary of the results of the model (eg. coefficient, p-value)
summary(m2)
```


```{r}
# Define the RMSE function
rmse <- function(t, p){
  se <- (t - p)^2
  mse <- mean(se)
  rmse <- sqrt(mse)
  return(rmse)
}
```

```{r}
# RMSE for model one
rmse_m1 <- rmse(db$price_usd, m1$fitted.values)
rmse_m1
```
```{r}
# RMSE for model two
rmse_m2 <- rmse(db$log1p_price_usd, m2$fitted.values)
rmse_m2
```
```{r}
# Calculate the mean of the price, log price and accommodates grouped by the property type
s <- aggregate(db[, 2:4], list(db$property_type), mean)
# Order by accommodates
s <- s[order(-s$accommodates), ]
```

# Part III
**Methods**  
Spatial heterogeneity takes geography as a systematic factor explaining a process, in this case the process of pricing a listing on Airbnb. To test it, a spatial fixed effect is introduced, in the forms including a neighborhood dummy variable. The spatial regimes, a generalization of the spatial fixed effect, is also used. While for the spatial fixed effect the constant changes accordingly to the neighborhood selected, with the spatial regimes every coefficient of the independent variables changes. Both approaches generate two new models, respectively model three and model four. The spatial dependence focus on understanding the relation of the observed characteristics based on their spatial distance. To test the spatial dependence, the spatial lag of the ‘accommodates’ variable is calculated. According to Perez-Sanchez et al. (2018), the number of people that an house accommodates is a key predictor of the price. In addition, more entire houses or apartments rented tend to accommodates more people (respectively, 4.6 and 4.2 people on average) than a private room in the same property type (1.79 people on average for both apartments or houses).It is worth noticing that while the spatial lag is included in the OLS model, it violates the required exogeneity since the error term of the spatial lag contains information about the outcome variable. Mathematically, space is modeled by a spatial weighted matrix where the weights are higher than zero if they are neighbors. The weights are also row standardized. The total neighbors to built the matrix are 50.

**Results and interpretation**  
The baseline model is identical to model two. As result, an assessment of the model has already been done in Part I. Model three includes a spatial fixed effect to understand if the price is systematically affected by geography in its behavior. model four through the spatial regimes aims to the same goal. In model three, using the neighborhoods as dummy variables the predictive power is equal to the baseline model (adjusted R-squared = 0.248) while the RMSE is slightly improved (0.74). The model with the spatial effect might be interpreted as predicting what’s the price of a listing when it is located in a certain neighborhood. For example, a listing in Valdefuentes, a notorious affluent area in Madrid, will increase the price by more than 70%. This model is really helpful to understand the single area impact on price. However, some of the neighborhoods’ coefficients are not statistically significant and the interpretation of the price pattern is possible only within the selected neighborhood.
In model four, all the coefficient estimates change based on the neighborhood, not just the constant. The predictive capability dramatically improves (adjusted R-squared = 0.87) but interpretability is still a bit complex since the coefficients can be interpreted only within an area. In the Trafalgar neighborhood, an increase in one extra ‘accommodates’ would increase the price by 61.8% but both one extra bedroom and one extra bed would actually decrease the price respectively by -34.3% and -38.7% while one extra bathroom would increase the price by 215%. These results might be driven by the kind of property type offering in the attractive and affluent area of Trafalgar and they are all statistically significant. In conclusion, model four might suggest that in the dynamics of Airbnb pricing in Madrid, geography, through its neighborhoods, plays an important role. However, there are some key aspects. Firstly, multiple coefficients across multiple neighborhoods are not statistically significant, secondly, the RMSE is almost double that in model three (1.48). Performing the predictive check (Figure 2), the overall picture is even more clear. The model is precise (high R-squared) but it is not accurate. The predicted outcomes are systematically lower (left-shifted) than the actual value, except for the high values.  
Model five explores how the price might depend on the surroundings’ observations and introduces the concept of assessing spatial dependence. The coefficient for the spatial lag included in the model suggests that the surrounding is a component to assess the price of an Airbnb listing based on how many people the other nearby listings might accommodate. An increase of the average total number that the apartment might accommodate in the 50 nearby listings by 1 unit, would increase the price by 10.28%. In other words, if all the nearby listings would be able to accommodate an extra person, the price of the observed listing should increase by 10%. This result might be interpreted that as an area offers houses that accommodate more people (for example, thanks to more entire apartments rented) leads to an increase in price for an observed listening. Other studies have shown how entire houses rented are concentrated in attractive central areas, creating an ‘hotelization’ of some city areas generated by multi-listing business entities (Barron et al., 2017; Wachsmuth et al., 2017; Horn et al., 2017), potentially building-up frictions with the local residents. It might also indicate that larger houses, potentially accommodating more people, are clustered together. The inherent number of potential guests of the observation is still the strongest predictors (20% increase by 1 accommodation), followed by the number of bedrooms (13.57% per 1 extra bedroom). The number of bathrooms and beds are both slightly negative as in the baseline model, respectively -5% and -6%. All the coefficients are statistically significant but the adjusted R-squared is still pretty low as in the baseline model (24%). Given the endogeneity nature of this model the findings need to be taken cautiously since it violates the OLS assumption.

```{r results = FALSE, message=FALSE, warning=FALSE}
# The baseline model is just like model two.
# Model three incorporates the spatial fixed term effect i.e. neighborhood
m3 <- lm('log1p_price_usd ~ accommodates + bathrooms + bedrooms + beds + neighbourhood', data=db)
# Show a summary of the results of the model (eg. coefficient, p-value)
summary(m3)
```
```{r}
# Calculate RMSE for model four
rmse_m3 <- rmse(db$log1p_price_usd, m3$fitted.values)
rmse_m3
```

```{r}
# Model with the spatial regimes at the neighborhood level
m4 <- lm('log1p_price_usd ~ 0 + (accommodates + bathrooms + bedrooms + beds):(neighbourhood)',data=db)
# Extend the max lines printed in the output
options(max.print=4000)
# Show a summary of the results of the model (eg. coefficient, p-value)
summary(m4)
```


```{r}
# Calculate RMSE for model four
rmse_m4 <- rmse(db$log1p_price_usd, m4$fitted.values)
rmse_m4
```
```{r}
generate_draw <- function(m){
  # Set up predictors matrix
  x <- model.matrix(m)
  # Obtain draws of parameters (inferential uncertainty)
  sim_bs <- sim(m, 1)
  # Predicted value
  mu <- x %*% sim_bs@coef[1, ]
  # Draw
  n <- length(mu)
  y_hat <- rnorm(n, mu, sim_bs@sigma[1])
  return(y_hat)
}
```

```{r}
# Multiplot different charts with 30% smaller font size title
par(mfrow = c(2,2), cex=0.7)

# Model One - Plot - Top Left
plot(
  density(m1$fitted.values), 
  # Set the X-axis range between the min of the price and 2000 since the  distribution is concentrated on lower values
  xlim=c(min(db$price_usd), 2000),
  main=''
)
# Set the density value to plot, color of the line and title blank
lines(
  density(db$price_usd), 
  col='blue',
  main=''
)
# Loop to plot the lines generate by the random draw
for(i in 1:300){
  tmp_y <- generate_draw(m1)  # Generate the lines
  lines(density(tmp_y),       # Plot the lines
        col='green',          # Set color green
        lwd=0.1               # Set line width
        )
}
# Set legend text, line colors, width
legend(
  'topright', 
  c('Predicted', 'Actual', 'Simulated (n=300)'),
  col=c('black', 'blue', 'green'),
  lwd=1
)
# Set title text
title(main="Model One - Predictive Check - Price")

# Model Two - Plot - Top Left
plot(
  density(m2$fitted.values), 
  xlim=c(0, max(db$log1p_price_usd)),
  main=''
)
# Set the density value to plot, color of the line and title blank
lines(
  density(db$log1p_price_usd), 
  col='blue',
  main=''
)
# Loop to plot the lines generate by the random draw
for(i in 1:300){
  tmp_y2 <- generate_draw(m2)
  lines(density(tmp_y2),
        col='green',
        lwd=0.1
        )
}
# Set legend text and line colors
legend(
  'topright', 
  c('Predicted', 'Actual', 'Simulated (n=300)'),
  col=c('black', 'blue', 'green'),
  lwd=1
)
# Set title text
title(main="Model Two - Predictive check - Log Price")

# Model three - Plot - Bottom Right
plot(
  density(m3$fitted.values), 
  # Set the X-axis limits
  xlim=c(0, max(db$log1p_price_usd)),
  main=''
)
# Set the density value to plot and color of the line
lines(
  density(db$log1p_price_usd), 
  col='blue',
  main=''
)

# Loop to plot the lines generate by the random draw
for(i in 1:300){
  tmp_y3 <- generate_draw(m3)
  lines(density(tmp_y3),
        col='green',
        lwd=0.1
        )
}

# Set legend, colors and text
legend(
  'topright', 
  c('Predicted', 'Actual','Simulated (n=300)'),
  col=c('black', 'blue', 'green'),
  lwd=1
)
# Set title text
title(main="Model three - Predictive Check - Spatial FE")

# Model four - Plot - Bottom Right
plot(
  density(m4$fitted.values), 
  # Set X-axis limit
  xlim=c(0, max(db$log1p_price_usd)),
  main=''
)
# Set the density value to plot, color of the line and title blank
lines(
  density(db$log1p_price_usd), 
  col='blue',
  main=''
)

# Set legend, colors and text
legend(
  'topright', 
  c('Predicted', 'Actual'),
  col=c('black', 'blue'),
  lwd=1
)
# Set title text
title(main="Model four - Predictive Check - Spatial Regimes")

# Model four - Plot - Bottom Right
plot(
  density(m5$fitted.values), 
  # Set X-axis limit
  xlim=c(min(db$log1p_price_usd), max(db$log1p_price_usd)),
  main=''
)
# Set the density value to plot, color of the line and title blank
lines(
  density(db$log1p_price_usd), 
  col='blue',
  main=''
)

# Set legend, colors and text
legend(
  'topright', 
  c('Predicted', 'Actual'),
  col=c('black', 'blue'),
  lwd=1
)
# Set title text
title(main="Model five - Predictive Check - Spatial Regimes")
```

```{r results = FALSE, message=FALSE, warning=FALSE}
# Create Spatial Matrix
# Create knn list of each house
hnn <- db %>%
  st_coordinates() %>% # Retrieve coordinates in matrix form
  as.matrix() %>% # Convert 1D array in 1D matrix
  knearneigh(k = 50) # Set k-neighbors to 50
# Create nb object
hnb <- knn2nb(hnn)
# Create spatial weights matrix (note it row-standardizes by default)
hknn <- nb2listw(hnb)
```

```{r results = FALSE, message=FALSE, warning=FALSE}
# Spatial Lag of bathrooms
db$w_accommodates <- lag.listw(hknn, db$accommodates)
```

```{r results = FALSE, message=FALSE, warning=FALSE}
m5 <- lm('log1p_price_usd ~ accommodates + bathrooms + bedrooms + beds + w_accommodates', data=db)
# Show a summary of the results of the model (eg. coefficient, p-value)
summary(m5)
```

```{r}
# Calculate RMSE for model five
rmse_m5 <- rmse(db$log1p_price_usd, m5$fitted.values)
rmse_m5
```
# Conclusions
Airbnb listings are fairly concentrated in the city-center while using a IDW interpolation prices are higher in the central-eastern and central-southern parts of the city. Given the skewed distribution of the price, the baseline model (with the logged price) is overall a better model than the first one as the predictive checks show (Figure 3). When it comes to including geography as a systemic explanatory element of the underlying pricing process (spatial heterogeneity), the spatial regime’s approach is more precise but less accurate (model four, figure 3) than model three with the spatial fixed’s approach. Lastly, the price of an Airbnb seems fairly dependent on the surroundings (spatial dependence) but the nature of the model and the low adjusted R-squared suggests to take the results cautiously.

# Bibliography
+ Barron, K., Kung, E., & Proserpio, D. (2017). The Sharing Economy and Housing Affordability: Evidence from Airbnb. Retrieved from. https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3006832
+ Gil, J.; Sequera, J. (2018). Expansión de La Ciudad Turrística y Nuevas Resistencias. El Caso de Airbnb En Madrid. EMPRITIA Rev. Metodol. Cienc. Soc., 41, 15–32.
+ Horn, K.; Merante, M. (2017) Is Home Sharing Driving up Rents? Evidence from Airbnb in Boston. J. Hous. Econ. 38, 14–24.
+ Wachsmuth, D., Kerrigan, D., Chaney, D., & Shillolo, A. (2017). Short-term cities: Airbnb's impact on Canadian housing markets. Retrieved from http://upgo.lab.mcgill.ca/airbnb/ Short-term%20Cities%202017-08-10.pdf